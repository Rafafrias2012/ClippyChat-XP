<html><head><base href="https://bonziworld.org/"><title>ClippyChat XP Edition</title>
<link rel="stylesheet" href="https://botoxparty.github.io/XP.css/XP.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body, html {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: "Tahoma", sans-serif;
    background: url('https://i.imgur.com/Zk6TR5k.jpg') no-repeat center center fixed;
    background-size: cover;
}
#chatbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: url('https://i.imgur.com/jADTSC0.png') repeat-x;
    border-top: 1px solid #0054E3;
    display: flex;
    align-items: center;
    padding: 0 5px;
}
#send_message {
    flex-grow: 1;
    margin-right: 5px;
    padding: 5px;
    border: 1px solid #7f9db9;
    background-color: white;
    height: 20px;
}
.xp-button {
    background: url('https://i.imgur.com/qSUUqNY.png') no-repeat;
    background-size: cover;
    border: none;
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 0 #0f3cdd;
    cursor: pointer;
    padding-left: 25px;
    text-align: left;
    height: 25px;
    margin-right: 5px;
}
.agent {
    position: absolute;
    cursor: move;
}
.speech-bubble {
    position: absolute;
    background: #FFFFCC;
    border: 1px solid #FFE79E;
    border-radius: 5px;
    padding: 10px;
    max-width: 200px;
    word-wrap: break-word;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    top: -80px;
    left: 50%;
    transform: translateX(-50%);
}
.username-bubble {
    position: absolute;
    background: linear-gradient(to bottom, #2A70DF 0%, #255BC7 100%);
    color: #fff;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 12px;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}
#room_info {
    position: fixed;
    bottom: 50px;
    right: 10px;
    background: rgba(255,255,255,0.8);
    padding: 5px;
    border: 1px solid #0054E3;
    border-radius: 3px;
}
#room_owner {
    display: none;
    color: #008000;
    font-weight: bold;
}
.rainbow-text {
    animation: rainbow 5s infinite;
}
@keyframes rainbow {
    0% { color: red; }
    14% { color: orange; }
    28% { color: yellow; }
    42% { color: green; }
    56% { color: blue; }
    70% { color: indigo; }
    84% { color: violet; }
    100% { color: red; }
}
.window {
    resize: both;
    overflow: auto;
    min-width: 200px;
    min-height: 100px;
}
#chat_log {
    height: calc(100% - 30px);
    overflow-y: auto;
    padding: 10px;
}
#version {
    position: fixed;
    bottom: 5px;
    right: 5px;
    font-size: 12px;
    color: #666;
}
@media (max-width: 768px) {
    #chatbar {
        padding: 5px;
    }
    #send_message {
        width: calc(100% - 60px);
    }
    .xp-button {
        width: 50px;
    }
    .speech-bubble {
        max-width: 150px;
    }
}
#error-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}
#error-message {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    text-align: center;
}
#chat_log_button {
    background: url('https://i.imgur.com/ZSDhCwu.png') no-repeat;
    background-size: contain;
    width: 24px;
    height: 24px;
    border: none;
    cursor: pointer;
    margin-right: 5px;
}
#welcome-window {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 300px;
    background: url('https://i.imgur.com/Zk6TR5k.jpg') no-repeat center center;
    background-size: cover;
    border: 1px solid #0054E3;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-shadow: 1px 1px 2px black;
}
#welcome-window h1 {
    font-size: 24px;
    margin-bottom: 20px;
}
#welcome-window button {
    margin-top: 20px;
}
#disconnect-logo, #kick-logo {
    width: 64px;
    height: 64px;
    margin-bottom: 10px;
}
#user-counter {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.8);
    padding: 5px;
    border: 1px solid #0054E3;
    border-radius: 3px;
}
#taskbar {
    position: fixed;
    bottom: 30px;
    left: 0;
    right: 0;
    height: 30px;
    background: url('https://i.imgur.com/jADTSC0.png') repeat-x;
    display: flex;
    align-items: center;
    padding: 0 5px;
}
.taskbar-icon {
    width: 24px;
    height: 24px;
    margin-right: 5px;
    cursor: pointer;
}

.context-menu {
    display: none;
    position: absolute;
    background-color: #ECE9D8;
    border: 1px solid #0054E3;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    z-index: 1000;
}

.context-menu ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

.context-menu li {
    padding: 8px 12px;
    cursor: pointer;
}

.context-menu li:hover {
    background-color: #316AC5;
    color: white;
}

#talkcard {
    display: none;
    background-color: #ECE9D8;
    border: 1px solid #0054E3;
    padding: 5px 10px;
    margin-bottom: 5px;
    font-size: 12px;
}

#talkcard i {
    float: right;
    cursor: pointer;
}
</style>
</head>
<body>
<div id="welcome-window" class="window">
    <div class="title-bar">
        <div class="title-bar-text">Welcome to ClippyChat XP</div>
    </div>
    <div class="window-body">
        <h1>Welcome to ClippyChat XP</h1>
        <p>Experience the nostalgia of Windows XP in a modern chat environment!</p>
        <button id="start-chat" class="xp-button">Start Chatting</button>
    </div>
</div>

<div id="login" class="window" style="width: 300px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
    <div class="title-bar">
        <div class="title-bar-text">ClippyChat XP Login</div>
    </div>
    <div class="window-body">
        <p>
            <label for="login_nickname">Nickname:</label>
            <input id="login_nickname" type="text">
        </p>
        <p>
            <label for="login_room">Room ID:</label>
            <input id="login_room" type="text">
        </p>
        <button id="login_button" class="xp-button">Join Chat</button>
        <button id="available-rooms" class="xp-button">Available Rooms</button>
    </div>
</div>

<div id="chat" style="display:none;">
    <div id="agents"></div>
    <div id="chatbar">
        <button id="chat_log_button" title="Toggle Chat Log"></button>
        <button id="tile_agents" class="xp-button">Tile</button>
        <input id="send_message" type="text" placeholder="Type your message...">
        <button id="send_button" class="xp-button">Send</button>
    </div>
    <div id="room_info">
        <span id="room_name"></span>
        <span id="room_owner">Room Owner</span>
    </div>
    <div id="taskbar">
        <img src="https://i.imgur.com/ZSDhCwu.png" alt="Clock" class="taskbar-icon" id="clock-icon">
        <img src="https://i.imgur.com/ZSDhCwu.png" alt="Calculator" class="taskbar-icon" id="calculator-icon">
    </div>

    <div id="talkcard"></div>

<div id="user-counter">Users: <span id="user-count">0</span></div>

<div id="version">V8.0.0</div>

<div id="error-overlay">
    <div id="error-message"></div>
</div>

<script>
const socket = io('https://bonziworld.org/');
let self = {};
let agents = {};
let announcements = [];
let level = 0;
let contextMenu = $('context-menu');
let talkcard = $('talkcard');
let talktarget = null;
window.talkstate = 0;
let welcomeversion = 2;
let settings = loadSettings();
const converter = new showdown.Converter();

// Windows XP Sounds
const sounds = {
    login: new Audio('https://www.myinstants.com/media/sounds/windows-xp-startup.mp3'),
    send: new Audio('https://www.myinstants.com/media/sounds/windows-xp-ding.mp3'),
    error: new Audio('https://www.myinstants.com/media/sounds/windows-xp-error.mp3')
};

function $(id) { return document.getElementById(id); }

function desanitize(text){
    return text.replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&apos;/g, "'").replace(/&lbrack;/g, "square bracket");
}

function range(start, end) {
    return Array.from({length: end - start + 1}, (_, i) => start + i);
}

function msWindow(title, html, x = 100, y = 100, w = 300, h = 200, callback) {
    let win = document.createElement('div');
    win.className = 'window';
    win.style.position = 'absolute';
    win.style.left = x + 'px';
    win.style.top = y + 'px';
    win.style.width = w + 'px';
    win.style.height = h + 'px';
    
    win.innerHTML = `
        <div class="title-bar">
            <div class="title-bar-text">${title}</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
            </div>
        </div>
        <div class="window-body" style="height: calc(100% - 30px); overflow: auto;">
            ${html}
        </div>
    `;
    
    document.body.appendChild(win);
    
    // Make window draggable
    let isDragging = false;
    let dragOffsetX, dragOffsetY;
    
    win.querySelector('.title-bar').addEventListener('mousedown', startDrag);
    win.querySelector('.title-bar').addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        isDragging = true;
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        dragOffsetX = clientX - win.offsetLeft;
        dragOffsetY = clientY - win.offsetTop;
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        win.style.left = (clientX - dragOffsetX) + 'px';
        win.style.top = (clientY - dragOffsetY) + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
    }
    
    // Maximize functionality
    win.querySelector('button[aria-label="Maximize"]').addEventListener('click', () => {
        if (win.style.width === '100%' && win.style.height === '100%') {
            win.style.width = w + 'px';
            win.style.height = h + 'px';
            win.style.left = x + 'px';
            win.style.top = y + 'px';
        } else {
            win.style.width = '100%';
            win.style.height = '100%';
            win.style.left = '0';
            win.style.top = '0';
        }
    });
    
    if (callback) callback(win);
    
    return win;
}

function agent(name, guid, x, y, sheet, color, voice) {
    this.name = name;
    this.guid = guid;
    this.x = x;
    this.y = y;
    this.sheet = sheet;
    this.color = color;
    this.voice = voice;
    this.id = 'agent_' + guid;
    
    let div = document.createElement('div');
    div.id = this.id;
    div.className = 'agent';
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    
    let canvas = document.createElement('canvas');
    let agentType = Math.floor(Math.random() * 6); // 0: Clippy, 1: Peedy, 2: Bonzi, 3: Genie, 4: Merlin
    
    if (agentType === 0) {
        canvas.width = 124;
        canvas.height = 93;
    } else if (agentType === 1) {
        canvas.width = 160;
        canvas.height = 128;
    } else if (agentType === 2) {
        canvas.width = 200;
        canvas.height = 160;
    } else if (agentType === 3 || 4) {
        canvas.width = 128;
        canvas.height = 128;
    } else {
        canvas.width = 180;
        canvas.height = 180;
    }
    
    div.appendChild(canvas);
    
    let username = document.createElement('div');
    username.id = this.id + 'n';
    username.className = 'username-bubble';
    username.innerText = name;
    div.appendChild(username);
    
    $('agents').appendChild(div);
    
    // Create sprite sheet based on agent type
    let spriteSheet;
    if (agentType === 0) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/clippy.png"],
            frames: {width: 124, height: 93},
            animations: {
                idle: 0,
                enter: {
                    frames: [410, 411, 412, 413, 414, 415, 416],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: [0].concat([...Array(48).keys()].map(i => i + 364)),
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 1) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/peedy.png"],
            frames: {width: 160, height: 128},
            animations: {
                idle: 0,
                enter: {
                    frames: [659, 660, 661, 662, 663, 664, 665, 666, 667, 668, 669, 670, 671, 672, 673, 674, 675, 676, 677, 678, 679, 680, 681],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: [23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47],
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 2) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/purple.png"],
            frames: {width: 200, height: 160},
            animations: {
                idle: 0,
                enter: {
                    frames: [277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: Array.from({ length: 55 }, (_, i) => i + 266),
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 3) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://raw.githubusercontent.com/dwarfpuzzles/Bonzi-oldstolencode/main/build/www/img/bonzi/genie.png"],
            frames: {width: 128, height: 128},
            animations: {
                idle: 0,
                leave: { frames: range(360, 412), next: "gone", speed: 1},
                enter: { frames: range(823, 848), next: "idle", speed: 1}
            }
        });
    } else if (agentType === 4) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://raw.githubusercontent.com/dwarfpuzzles/Bonzi-oldstolencode/main/build/www/img/bonzi/merlin.png"],
            frames: {width: 128, height: 128},
            animations: {
                idle: 0,
                leave: { frames: range(360, 412), next: "gone", speed: 1},
                enter: { frames: range(823, 848), next: "idle", speed: 1}
            }
        });
    } else {
        spriteSheet = new createjs.SpriteSheet({
            images: ["victor.png"],
            frames: {width: 180, height: 180},
            animations: {
                idle: 0,
                enter: {
                    frames: [716, 717, 718, 719, 720, 721, 722, 723, 724, 725, 726, 727, 728, 729, 730, 731, 732, 733, 734, 735, 736, 737, 738, 739, 740, 741, 742, 743, 744, 745, 746, 747],
                    next: "idle",
                    speed: 0.5
                },
                leave: {
                    frames: Array.from({length: 55}, (_, i) => 266 + i),
                    speed: 0.25
                }
            }
        });
    }
    
    // Create sprite
    this.sprite = new createjs.Sprite(spriteSheet, "idle");
    
    // Create stage and add sprite to it
    this.stage = new createjs.Stage(canvas);
    this.stage.addChild(this.sprite);
    
    // Update stage
    createjs.Ticker.addEventListener("tick", this.stage);
    
    this.talk = function(text, say) {
        let bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        
        // Convert markdown to HTML
        let htmlText = converter.makeHtml(text);
        
        // Process rainbow text
        htmlText = htmlText.replace(/\$r\$(.*?)\$r\$/g, '<span class="rainbow-text">$1</span>');
        
        // Desanitize the text
        htmlText = desanitize(htmlText);
        
        // Censor R34 images
        htmlText = htmlText.replace(/<img.*?src=".*?rule34\.xxx.*?".*?>/gi, '[R34 Image Censored]');
        
        // Linkify URLs
        htmlText = htmlText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        
        bubble.innerHTML = htmlText;
        div.appendChild(bubble);
        
        setTimeout(() => bubble.remove(), 5000);
        
        let url = "https://www.tetyys.com/SAPI4/SAPI4?text=" + encodeURIComponent(say) + "&voice=" + encodeURIComponent("Sam") + "&pitch=150&speed=100";
        let audio = new Audio(url);
        audio.play();
    }
    
    this.change = function(newColor) {
        this.color = newColor;
        // You would need to update the sprite sheet here with the new color's image
    }
    
    this.kill = function() {
        this.sprite.gotoAndPlay("leave");
        this.sprite.addEventListener("animationend", () => {
            div.remove();
        });
    }
    
    this.actqueue = function(queue, index) {
        if (index >= queue.length) return;
        let act = queue[index];
        // Implement act logic here
        setTimeout(() => this.actqueue(queue, index + 1), act.duration || 1000);
    }
    
    // Make agent draggable
    let isDragging = false;
    let dragOffsetX, dragOffsetY;
    
    div.addEventListener('mousedown', startDrag);
    div.addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        isDragging = true;
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        dragOffsetX = clientX - div.offsetLeft;
        dragOffsetY = clientY - div.offsetTop;
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        div.style.left = (clientX - dragOffsetX) + 'px';
        div.style.top = (clientY - dragOffsetY) + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
    }
    
    // Play enter animation
    this.sprite.gotoAndPlay("enter");
}

function send() {
    let tosend = $("send_message").value;
    if (window.talkstate == 2) {
        talkcard.style.display = "none";
        window.talkstate = 0;
        socket.emit("command", {
            command: "reply",
            param: talktarget + " " + tosend
        });
    } else if (window.talkstate == 1) {
        talkcard.style.display = "none";
        window.talkstate = 0;
        socket.emit("command", {
            command: "dm",
            param: talktarget + " " + tosend
        });
    } else if (tosend.startsWith("/")) {
        let comd = tosend.split(" ")[0].replace("/", '');
        let param = tosend.includes(" ") ? tosend.substring(tosend.indexOf(" ") + 1, tosend.length) : "";
        socket.emit("command", {command: comd, param: param});
    } else {
        socket.emit("talk", $("send_message").value);
    }
    $("send_message").value = "";
    sounds.send.play();
}

$("start-chat").addEventListener("click", function() {
    $("welcome-window").style.display = "none";
    $("login").style.display = "block";
});

$("login_button").addEventListener("click", function() {
    self = {
        name: $("login_nickname").value,
        room: $("login_room").value,
        color: ""
    };
    socket.emit("login", self);
    sounds.login.play();
});

$("send_button").addEventListener("click", send);
$("send_message").addEventListener("keydown", function(e) {
    if (e.keyCode === 13) send();
});

$("tile_agents").addEventListener("click", function() {
    let agentDivs = document.querySelectorAll('.agent');
    let containerWidth = window.innerWidth;
    let containerHeight = window.innerHeight - 50; // Subtracting height of chatbar
    let cols = Math.floor(Math.sqrt(agentDivs.length));
    let rows = Math.ceil(agentDivs.length / cols);
    let cellWidth = containerWidth / cols;
    let cellHeight = containerHeight / rows;

    agentDivs.forEach((div, index) => {
        let row = Math.floor(index / cols);
        let col = index % cols;
        div.style.left = (col * cellWidth + (cellWidth - div.offsetWidth) / 2) + 'px';
        div.style.top = (row * cellHeight + (cellHeight - div.offsetHeight) / 2) + 'px';
    });
});

$("available-rooms").addEventListener("click", function() {
    socket.emit("get_rooms");
});

$("clock-icon").addEventListener("click", function() {
    let clockWindow = msWindow("Clock", `
        <div id="clock" style="font-size: 24px; text-align: center; margin-top: 20px;"></div>
    `, 100, 100, 200, 150);
    
    function updateClock() {
        let now = new Date();
        let clockElement = clockWindow.querySelector("#clock");
        clockElement.textContent = now.toLocaleTimeString();
    }
    
    updateClock();
    setInterval(updateClock, 1000);
});

$("calculator-icon").addEventListener("click", function() {
    let calcWindow = msWindow("Calculator", `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px;">
            <input type="text" id="calc-display" style="grid-column: span 4; margin-bottom: 10px;">
            <button onclick="document.getElementById('calc-display').value=''">C</button>
            <button onclick="document.getElementById('calc-display').value+='7'">7</button>
            <button onclick="document.getElementById('calc-display').value+='8'">8</button>
            <button onclick="document.getElementById('calc-display').value+='9'">9</button>
            <button onclick="document.getElementById('calc-display').value+='4'">4</button>
            <button onclick="document.getElementById('calc-display').value+='5'">5</button>
            <button onclick="document.getElementById('calc-display').value+='6'">6</button>
            <button onclick="document.getElementById('calc-display').value+='1'">1</button>
            <button onclick="document.getElementById('calc-display').value+='2'">2</button>
            <button onclick="document.getElementById('calc-display').value+='3'">3</button>
            <button onclick="document.getElementById('calc-display').value+='0'">0</button>
            <button onclick="document.getElementById('calc-display').value+='.'">.</button>
            <button onclick="document.getElementById('calc-display').value+='+'">+</button>
            <button onclick="document.getElementById('calc-display').value+='-'">-</button>
            <button onclick="document.getElementById('calc-display').value+='*'">*</button>
            <button onclick="document.getElementById('calc-display').value+='/'">/</button>
            <button onclick="try{document.getElementById('calc-display').value=eval(document.getElementById('calc-display').value)}catch(e){document.getElementById('calc-display').value='Error'}" style="grid-column: span 4;">=</button>
        </div>
    `, 150, 150, 250, 300);
});

socket.on("login", function(logindata) {
    $("login").style.display = "none";
    $("chat").style.display = "block";
    $("room_name").innerText = "Room: " + self.room;
    
    Object.keys(logindata.users).forEach(userkey => {
        let user = logindata.users[userkey];
        let x = Math.floor(Math.random() * (window.innerWidth - 200));
        let y = Math.floor(Math.random() * (window.innerHeight - 160 - 32));
        agents[userkey] = new agent(user.name, userkey, x, y, null, user.color, user.voice);
    });
    
    updateUserCount(Object.keys(logindata.users).length);
});

socket.on("join", function(user) {
    let x = Math.floor(Math.random() * (window.innerWidth - 200));
    let y = Math.floor(Math.random() * (window.innerHeight - 160 - 32));
    agents[user.guid] = new agent(user.name, user.guid, x, y, null, user.color, user.voice);
    updateUserCount(Object.keys(agents).length);
});

socket.on("leave", function(guid) {
    agents[guid].kill();
    delete agents[guid];
    updateUserCount(Object.keys(agents).length);
});

socket.on("update", function(user) {
    let agent = agents[user.guid];
    if (agent) {
        $(agent.id + "n").innerHTML = user.name;
        agent.voice = user.voice;
        if (user.color != agent.color) {
            agent.change(user.color);
        }
    }
});

socket.on("talk", function(text) {
    agents[text.guid].talk(text.text, text.text);
});

socket.on("actqueue", function(queue) {
    agents[queue.guid].actqueue(queue.list, 0);
});

socket.on("update_self", function(info) {
    level = info.level;
    if (info.roomowner) $("room_owner").style.display = "block";
});

socket.on("kick", function(kicker) {
    msWindow("Kicked", `<img id="kick-logo" src="https://i.imgur.com/jacoj5E.png" alt="Kick Logo"><p>You have been kicked by ${kicker}</p>`);
    sounds.error.play();
});

socket.on("announce", function(data) {
    announcements.push(new msWindow(data.title, data.html));
    if (announcements.length > 3) {
        announcements[0].remove();
        announcements.shift();
    }
});

socket.on("room_list", function(rooms) {
    let roomList = rooms.map(room => `<li>${room.name} (${room.users} users)</li>`).join('');
    msWindow("Available Rooms", `<ul>${roomList}</ul>`);
});

// Chat log window
let chatLogWindow;
function toggleChatLog() {
    if (chatLogWindow) {
        chatLogWindow.remove();
        chatLogWindow = null;
    } else {
        chatLogWindow = msWindow("Chat Log", '<div id="chat_log"></div>', 10, 10, 300, 400);
    }
}

$("chat_log_button").addEventListener('click', toggleChatLog);

function addToChatLog(message) {
    if (chatLogWindow) {
        let chatLog = chatLogWindow.querySelector('#chat_log');
        let entry = document.createElement('div');
        entry.innerHTML = message;
        chatLog.appendChild(entry);
        chatLog.scrollTop = chatLog.scrollHeight;
    }
}

socket.on("talk", function(text) {
    agents[text.guid].talk(text.text, text.text);
    let htmlText = converter.makeHtml(text.text);
    htmlText = htmlText.replace(/\$r\$(.*?)\$r\$/g, '<span class="rainbow-text">$1</span>');
    htmlText = desanitize(htmlText);
    // Linkify URLs
    htmlText = htmlText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    addToChatLog(`<strong>${agents[text.guid].name}:</strong> ${htmlText}`);
});

// Error handling and disconnection
socket.on('connect_error', (error) => {
    showError('Connection Error', '<img id="disconnect-logo" src="https://i.imgur.com/jacoj5E.png" alt="Disconnect Logo"><p>Unable to connect to the server. Please check your internet connection and try again.</p>');
    sounds.error.play();
});

socket.on('disconnect', (reason) => {
    if (reason === 'io server disconnect') {
        showError('Disconnected', '<img id="disconnect-logo" src="https://i.imgur.com/jacoj5E.png" alt="Disconnect Logo"><p>You have been disconnected from the server.</p>');
    } else {
        showError('Connection Lost', '<img id="disconnect-logo" src="https://i.imgur.com/jacoj5E.png" alt="Disconnect Logo"><p>Lost connection to the server. Attempting to reconnect...</p>');
    }
    sounds.error.play();
    if (autojoin) {
        setTimeout(() => {
            socket.connect();
            socket.emit("login", self);
        }, 5000);
    }
});

function showError(title, message) {
    $('error-overlay').style.display = 'flex';
    $('error-message').innerHTML = `<h2>${title}</h2>${message}`;
}

// Add a close button to the error message
let closeErrorButton = document.createElement('button');
closeErrorButton.innerText = 'Close';
closeErrorButton.onclick = () => {
    $('error-overlay').style.display = 'none';
};
$('error-message').appendChild(closeErrorButton);

function updateUserCount(count) {
    $('user-count').innerText = count;
}

// Windows XP Icon Function
function createWindowsXPIcon(name, iconUrl, clickHandler) {
    let icon = document.createElement('div');
    icon.className = 'windows-xp-icon';
    icon.style.width = '64px';
    icon.style.height = '64px';
    icon.style.position = 'absolute';
    icon.style.cursor = 'pointer';
    icon.style.textAlign = 'center';
    
    let img = document.createElement('img');
    img.src = iconUrl;
    img.style.width = '32px';
    img.style.height = '32px';
    
    let text = document.createElement('div');
    text.textContent = name;
    text.style.fontSize = '12px';
    text.style.wordWrap = 'break-word';
    text.style.color = 'white';
    text.style.textShadow = '1px 1px 1px black';
    
    icon.appendChild(img);
    icon.appendChild(text);
    
    icon.addEventListener('click', clickHandler);
    
    document.body.appendChild(icon);
    
    return icon;
}

// Create desktop icons
createWindowsXPIcon('My Computer', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/MyComputer.png', () => {
    msWindow('My Computer', '<p>This is your computer.</p>');
});

createWindowsXPIcon('Recycle Bin', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/RecycleBin(empty).png', () => {
    msWindow('Recycle Bin', '<p>The recycle bin is empty.</p>');
});

createWindowsXPIcon('Internet Explorer', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/InternetExplorer6.png', () => {
    msWindow('Internet Explorer', '<iframe src="https://www.example.com" style="width: 100%; height: 100%; border: none;"></iframe>', 100, 100, 800, 600);
});

// Position icons
let icons = document.querySelectorAll('.windows-xp-icon');
icons.forEach((icon, index) => {
    icon.style.left = '10px';
    icon.style.top = (10 + index * 80) + 'px';
});

createWindowsXPIcon('Control Panel', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/ControlPanel.png', () => {
    msWindow('Control Panel', `
        <h2>Settings</h2>
        <button id="change-background">Change Background</button>
        <button id="change-theme">Change Theme</button>
        <label><input type="checkbox" id="auto-join"> Enable Autojoin</label>
    `, 100, 100, 300, 200, (win) => {
        win.querySelector('#change-background').addEventListener('click', changeBackground);
        win.querySelector('#change-theme').addEventListener('click', changeTheme);
        win.querySelector('#auto-join').addEventListener('change', toggleAutojoin);
    });
});

function changeBackground() {
    let newBackground = prompt("Enter new background URL:");
    if (newBackground) {
        document.body.style.backgroundImage = `url('${newBackground}')`;
    }
}

function changeTheme() {
    let newTheme = prompt("Enter new theme URL:");
    if (newTheme) {
        let link = document.querySelector("link[href^='https://botoxparty.github.io/XP.css/XP.css']");
        if (link) {
            link.href = newTheme;
        }
    }
}

let autojoin = false;
function toggleAutojoin(e) {
    autojoin = e.target.checked;
}

// Poll functionality
let poll;

socket.on("poll", data => {
    if (poll != undefined) {
        poll.remove();
    }
    poll = msWindow("Poll from " + data.name, `
      <h1>${data.title}</h1>
      <div id="pollyes"><div id="innerbar_yes"></div><span class='polltx'>YES</span></div>
      <div id="pollno"><div id="innerbar_no"></div><span class='polltx'>NO</span></div>
      <span id="votecount">0</span> Votes!
      `, undefined, undefined, window.innerWidth / 2);
    $("pollyes").onclick = () => {
        socket.emit('command', {
            command: 'vote',
            param: 'yes'
        })
    }
    $("pollno").onclick = () => {
        socket.emit('command', {
            command: 'vote',
            param: 'no'
        })
    }
});

socket.on("vote", data => {
    if (poll == undefined) return;
    let tvotes = data.yes + data.no;
    $("innerbar_yes").style.width = data.yes / tvotes * 100 + "%";
    $("innerbar_no").style.width = data.no / tvotes * 100 + "%";
    $("votecount").innerHTML = tvotes;
});

function showContextMenu(e, agentId) {
    e.preventDefault();
    contextMenu.style.display = 'block';
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
    talktarget = agentId;
}

$('reply-option').addEventListener('click', () => {
    window.talkstate = 2;
    talkcard.innerHTML = `Replying to ${agents[talktarget].name} <i class='fa fa-times' onclick='this.parentElement.style.display="none";window.talkstate=0;'></i>`;
    talkcard.style.display = "inline-block";
    contextMenu.style.display = 'none';
});

$('dm-option').addEventListener('click', () => {
    window.talkstate = 1;
    talkcard.innerHTML = `Sending a private message to ${agents[talktarget].name} <i class='fa fa-times' onclick='this.parentElement.style.display="none";window.talkstate=0;'></i>`;
    talkcard.style.display = "inline-block";
    contextMenu.style.display = 'none';
});

document.addEventListener('click', () => {
    contextMenu.style.display = 'none';
});

document.addEventListener("contextmenu", mouse => {
    mouse.preventDefault();
    moving = false;
    //Find agent the mouse is over
    let bid = -1;
    Object.keys(agents).forEach((akey) => {
        //Check if within bounds of an agent. Pretty long condition.
        if (
            mouse.clientX > agents[akey].x &&
            mouse.clientX < agents[akey].x + agents[akey].w &&
            mouse.clientY > agents[akey].y &&
            mouse.clientY < agents[akey].y + agents[akey].h + agents[akey].toppad
        ) bid = akey;
    })

    //Contextmenu if found passing agent through
    if (bid > -1) {
        //Define the contextmenu upon click (so it can be dynamic)
        let cmenu = [{
            type: 0,
            name: "Cancel",
            callback: (passthrough) => {
                passthrough.cancel();
            }
        }, {
            type: 0,
            name: "Call an Asshole",
            callback: (passthrough) => {
                socket.emit("command", {
                    command: "asshole",
                    param: passthrough.name
                })
            }
        }, {
            type: 0,
            name: "Notice Bulge",
            callback: (passthrough) => {
                socket.emit("command", {
                    command: "owo",
                    param: passthrough.name
                })
            }
        }, {
            type: 0,
            name: "Kick",
            disabled: level < 1,
            callback: (passthrough) => {
                socket.emit("command", {
                    command: "kick",
                    param: passthrough.id
                })
            }
        }]
        contextmenu(cmenu, mouse.clientX, mouse.clientY, agents[bid]);
    }
})

function contextmenu(items, x, y, passthrough) {
    let menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';

    items.forEach(item => {
        let menuItem = document.createElement('div');
        menuItem.className = 'context-menu-item';
        menuItem.textContent = item.name;
        if (item.disabled) {
            menuItem.classList.add('disabled');
        } else {
            menuItem.addEventListener('click', () => {
                item.callback(passthrough);
                menu.remove();
            });
        }
        menu.appendChild(menuItem);
    });

    document.body.appendChild(menu);

    document.addEventListener('click', function closeMenu() {
        menu.remove();
        document.removeEventListener('click', closeMenu);
    });
}

// Add this to your existing styles
const additionalStyles = `
.context-menu {
    position: absolute;
    background-color: #f0f0f0;
    border: 1px solid #999;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    padding: 5px 0;
    z-index: 1000;
}

.context-menu-item {
    padding: 5px 20px;
    cursor: pointer;
}

.context-menu-item:hover {
    background-color: #e0e0e0;
}

.context-menu-item.disabled {
    color: #999;
    cursor: default;
}

.context-menu-item.disabled:hover {
    background-color: transparent;
}
`;

let styleElement = document.createElement('style');
styleElement.textContent = additionalStyles;
document.head.appendChild(styleElement);

function loadSettings() {
    let cookie = document.cookie.split(';').find(row => row.trim().startsWith('settings='));
    return cookie ? JSON.parse(cookie.split('=')[1]) : { welcome: 0 };
}

function compileCookie(settings) {
    return 'settings=' + JSON.stringify(settings) + ';path=/;expires=' + new Date(Date.now() + 31536000000).toUTCString();
}

if (settings.welcome != welcomeversion) {
    settings.welcome = welcomeversion;
    document.cookie = compileCookie(settings);
    
    // Show welcome window
    let welcomeWindow = msWindow("Welcome to ClippyChat XP V8.0.0G", `
        <div id="welcome-window">
            <h1>Welcome to ClippyChat XP</h1>
            <p>Experience the nostalgia of Windows XP in a modern chat environment!</p>
            <p>New in this version:</p>
            <ul>
                <li>Added Victor</li>
            </ul>
            <button id="start-chat" class="xp-button">Start Chatting</button>
        </div>
    `, 100, 100, 400, 300);

    $("start-chat").addEventListener("click", function() {
        welcomeWindow.remove();
        $("login").style.display = "block";
    });
}



</script>
</body>
</html>
