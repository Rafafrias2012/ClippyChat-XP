<html><head><base href="https://bonziworld.org/"><title>ClippyChat XP Edition</title>
<link rel="stylesheet" href="https://botoxparty.github.io/XP.css/XP.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
<style>
body, html {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: "Tahoma", sans-serif;
    background: url('https://i.imgur.com/Zk6TR5k.jpg') no-repeat center center fixed;
    background-size: cover;
}
#chatbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: url('https://i.imgur.com/jADTSC0.png') repeat-x;
    border-top: 1px solid #0054E3;
    display: flex;
    align-items: center;
    padding: 0 5px;
}
#send_message {
    flex-grow: 1;
    margin-right: 5px;
    padding: 5px;
    border: 1px solid #7f9db9;
    background-color: white;
    height: 20px;
}
#send_button {
    width: 70px;
    height: 25px;
    background: url('https://i.imgur.com/qSUUqNY.png') no-repeat;
    background-size: cover;
    border: none;
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 0 #0f3cdd;
    cursor: pointer;
    padding-left: 25px;
    text-align: left;
}
#tile_agents {
    width: 70px;
    height: 25px;
    background: url('https://i.imgur.com/qSUUqNY.png') no-repeat;
    background-size: cover;
    border: none;
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 0 #0f3cdd;
    cursor: pointer;
    margin-right: 5px;
    padding-left: 25px;
    text-align: left;
}
.agent {
    position: absolute;
    cursor: move;
}
.speech-bubble {
    position: absolute;
    background: #FFFFCC;
    border: 1px solid #FFE79E;
    border-radius: 5px;
    padding: 10px;
    max-width: 200px;
    word-wrap: break-word;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    top: -80px;
    left: 50%;
    transform: translateX(-50%);
}
.username-bubble {
    position: absolute;
    background: linear-gradient(to bottom, #2A70DF 0%, #255BC7 100%);
    color: #fff;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 12px;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}
#room_info {
    position: fixed;
    bottom: 50px;
    right: 10px;
    background: rgba(255,255,255,0.8);
    padding: 5px;
    border: 1px solid #0054E3;
    border-radius: 3px;
}
#room_owner {
    display: none;
    color: #008000;
    font-weight: bold;
}
.rainbow-text {
    animation: rainbow 5s infinite;
}
@keyframes rainbow {
    0% { color: red; }
    14% { color: orange; }
    28% { color: yellow; }
    42% { color: green; }
    56% { color: blue; }
    70% { color: indigo; }
    84% { color: violet; }
    100% { color: red; }
}
.window {
    resize: both;
    overflow: auto;
    min-width: 200px;
    min-height: 100px;
}
#chat_log {
    height: calc(100% - 30px);
    overflow-y: auto;
    padding: 10px;
}
#version {
    position: fixed;
    bottom: 5px;
    right: 5px;
    font-size: 12px;
    color: #666;
}
@media (max-width: 768px) {
    #chatbar {
        padding: 5px;
    }
    #send_message {
        width: calc(100% - 60px);
    }
    #send_button {
        width: 50px;
    }
    .speech-bubble {
        max-width: 150px;
    }
}
#error-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}
#error-message {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    text-align: center;
}
#chat_log_button {
    background: url('https://i.imgur.com/ZSDhCwu.png') no-repeat;
    background-size: contain;
    width: 24px;
    height: 24px;
    border: none;
    cursor: pointer;
    margin-right: 5px;
}
</style>
</head>
<body>
<div id="login" class="window" style="width: 300px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <div class="title-bar">
        <div class="title-bar-text">ClippyChat XP Login</div>
    </div>
    <div class="window-body">
        <p>
            <label for="login_nickname">Nickname:</label>
            <input id="login_nickname" type="text">
        </p>
        <p>
            <label for="login_room">Room ID:</label>
            <input id="login_room" type="text">
        </p>
        <button id="login_button">Join Chat</button>
    </div>
</div>

<div id="chat" style="display:none;">
    <div id="agents"></div>
    <div id="chatbar">
        <button id="chat_log_button" title="Toggle Chat Log"></button>
        <button id="tile_agents">Tile</button>
        <input id="send_message" type="text" placeholder="Type your message...">
        <button id="send_button">Send</button>
    </div>
    <div id="room_info">
        <span id="room_name"></span>
        <span id="room_owner">Room Owner</span>
    </div>
</div>

<div id="version">V1.0.0B</div>

<div id="error-overlay">
    <div id="error-message"></div>
</div>

<script>
const socket = io('https://bonziworld.org/');
let self = {};
let agents = {};
let announcements = [];
let level = 0;
const converter = new showdown.Converter();

// Windows XP Sounds
const sounds = {
    login: new Audio('https://www.myinstants.com/media/sounds/windows-xp-startup.mp3'),
    send: new Audio('https://www.myinstants.com/media/sounds/windows-xp-ding.mp3'),
    error: new Audio('https://www.myinstants.com/media/sounds/windows-xp-error.mp3')
};

function $(id) { return document.getElementById(id); }

function desanitize(text){
    return text.replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&apos;/g, "'").replace(/&lbrack;/g, "square bracket");
}

function range(start, end) {
    return Array.from({length: end - start + 1}, (_, i) => start + i);
}

function msWindow(title, html, x = 100, y = 100, w = 300, h = 200, callback) {
    let win = document.createElement('div');
    win.className = 'window';
    win.style.position = 'absolute';
    win.style.left = x + 'px';
    win.style.top = y + 'px';
    win.style.width = w + 'px';
    win.style.height = h + 'px';
    
    win.innerHTML = `
        <div class="title-bar">
            <div class="title-bar-text">${title}</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
            </div>
        </div>
        <div class="window-body" style="height: calc(100% - 30px); overflow: auto;">
            ${html}
        </div>
    `;
    
    document.body.appendChild(win);
    
    // Make window draggable
    let isDragging = false;
    let dragOffsetX, dragOffsetY;
    
    win.querySelector('.title-bar').addEventListener('mousedown', startDrag);
    win.querySelector('.title-bar').addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        isDragging = true;
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        dragOffsetX = clientX - win.offsetLeft;
        dragOffsetY = clientY - win.offsetTop;
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        win.style.left = (clientX - dragOffsetX) + 'px';
        win.style.top = (clientY - dragOffsetY) + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
    }
    
    // Maximize functionality
    win.querySelector('button[aria-label="Maximize"]').addEventListener('click', () => {
        if (win.style.width === '100%' && win.style.height === '100%') {
            win.style.width = w + 'px';
            win.style.height = h + 'px';
            win.style.left = x + 'px';
            win.style.top = y + 'px';
        } else {
            win.style.width = '100%';
            win.style.height = '100%';
            win.style.left = '0';
            win.style.top = '0';
        }
    });
    
    if (callback) callback(win);
    
    return win;
}

function agent(name, guid, x, y, sheet, color, voice) {
    this.name = name;
    this.guid = guid;
    this.x = x;
    this.y = y;
    this.sheet = sheet;
    this.color = color;
    this.voice = voice;
    this.id = 'agent_' + guid;
    
    let div = document.createElement('div');
    div.id = this.id;
    div.className = 'agent';
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    
    let canvas = document.createElement('canvas');
    let agentType = Math.floor(Math.random() * 5); // 0: Clippy, 1: Peedy, 2: Bonzi, 3: Genie, 4: Merlin
    
    if (agentType === 0) {
        canvas.width = 124;
        canvas.height = 93;
    } else if (agentType === 1) {
        canvas.width = 160;
        canvas.height = 128;
    } else if (agentType === 2) {
        canvas.width = 200;
        canvas.height = 160;
    } else {
        canvas.width = 128;
        canvas.height = 128;
    }
    
    div.appendChild(canvas);
    
    let username = document.createElement('div');
    username.id = this.id + 'n';
    username.className = 'username-bubble';
    username.innerText = name;
    div.appendChild(username);
    
    $('agents').appendChild(div);
    
    // Create sprite sheet based on agent type
    let spriteSheet;
    if (agentType === 0) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/clippy.png"],
            frames: {width: 124, height: 93},
            animations: {
                idle: 0,
                enter: {
                    frames: [410, 411, 412, 413, 414, 415, 416],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: [0].concat([...Array(48).keys()].map(i => i + 364)),
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 1) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/peedy.png"],
            frames: {width: 160, height: 128},
            animations: {
                idle: 0,
                enter: {
                    frames: [659, 660, 661, 662, 663, 664, 665, 666, 667, 668, 669, 670, 671, 672, 673, 674, 675, 676, 677, 678, 679, 680, 681],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: [23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47],
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 2) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/purple.png"],
            frames: {width: 200, height: 160},
            animations: {
                idle: 0,
                enter: {
                    frames: [277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40],
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 3) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://raw.githubusercontent.com/dwarfpuzzles/Bonzi-oldstolencode/main/build/www/img/bonzi/genie.png"],
            frames: {width: 128, height: 128},
            animations: {
                idle: 0,
                surf_away: { frames: range(360, 412), next: "gone", speed: 1},
                surf_intro: { frames: range(823, 848), next: "idle", speed: 1}
            }
        });
    } else {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://raw.githubusercontent.com/dwarfpuzzles/Bonzi-oldstolencode/main/build/www/img/bonzi/merlin.png"],
            frames: {width: 128, height: 128},
            animations: {
                idle: 0,
                surf_away: { frames: range(360, 412), next: "gone", speed: 1},
                surf_intro: { frames: range(823, 848), next: "idle", speed: 1}
            }
        });
    }
    
    // Create sprite
    this.sprite = new createjs.Sprite(spriteSheet, "idle");
    
    // Create stage and add sprite to it
    this.stage = new createjs.Stage(canvas);
    this.stage.addChild(this.sprite);
    
    // Update stage
    createjs.Ticker.addEventListener("tick", this.stage);
    
    this.talk = function(text, say) {
        let bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        
        // Convert markdown to HTML
        let htmlText = converter.makeHtml(text);
        
        // Process rainbow text
        htmlText = htmlText.replace(/\$r\$(.*?)\$r\$/g, '<span class="rainbow-text">$1</span>');
        
        // Desanitize the text
        htmlText = desanitize(htmlText);
        
        // Censor R34 images
        htmlText = htmlText.replace(/<img.*?src=".*?rule34\.xxx.*?".*?>/gi, '[R34 Image Censored]');
        
        // Linkify URLs
        htmlText = htmlText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        
        bubble.innerHTML = htmlText;
        div.appendChild(bubble);
        
        setTimeout(() => bubble.remove(), 5000);
        
        let url = "https://www.tetyys.com/SAPI4/SAPI4?text=" + encodeURIComponent(say) + "&voice=" + encodeURIComponent("Sam") + "&pitch=150&speed=100";
        let audio = new Audio(url);
        audio.play();
    }
    
    this.change = function(newColor) {
        this.color = newColor;
        // You would need to update the sprite sheet here with the new color's image
    }
    
    this.kill = function() {
        this.sprite.gotoAndPlay("leave");
        this.sprite.addEventListener("animationend", () => {
            div.remove();
        });
    }
    
    this.actqueue = function(queue, index) {
        if (index >= queue.length) return;
        let act = queue[index];
        // Implement act logic here
        setTimeout(() => this.actqueue(queue, index + 1), act.duration || 1000);
    }
    
    // Make agent draggable
    let isDragging = false;
    let dragOffsetX, dragOffsetY;
    
    div.addEventListener('mousedown', startDrag);
    div.addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        isDragging = true;
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        dragOffsetX = clientX - div.offsetLeft;
        dragOffsetY = clientY - div.offsetTop;
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        div.style.left = (clientX - dragOffsetX) + 'px';
        div.style.top = (clientY - dragOffsetY) + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
    }
    
    // Play enter animation
    this.sprite.gotoAndPlay("enter");
}

function send() {
    let tosend = $("send_message").value;
    if (tosend.startsWith("/")) {
        let comd = tosend.split(" ")[0].replace("/", '');
        let param = tosend.includes(" ") ? tosend.substring(tosend.indexOf(" ") + 1, tosend.length) : "";
        socket.emit("command", {command: comd, param: param});
    } else {
        socket.emit("talk", $("send_message").value);
    }
    $("send_message").value = "";
    sounds.send.play();
}

$("login_button").addEventListener("click", function() {
    self = {
        name: $("login_nickname").value,
        room: $("login_room").value,
        color: ""
    };
    socket.emit("login", self);
    sounds.login.play();
});

$("send_button").addEventListener("click", send);
$("send_message").addEventListener("keydown", function(e) {
    if (e.keyCode === 13) send();
});

$("tile_agents").addEventListener("click", function() {
    let agentDivs = document.querySelectorAll('.agent');
    let containerWidth = window.innerWidth;
    let containerHeight = window.innerHeight - 50; // Subtracting height of chatbar
    let cols = Math.floor(Math.sqrt(agentDivs.length));
    let rows = Math.ceil(agentDivs.length / cols);
    let cellWidth = containerWidth / cols;
    let cellHeight = containerHeight / rows;

    agentDivs.forEach((div, index) => {
        let row = Math.floor(index / cols);
        let col = index % cols;
        div.style.left = (col * cellWidth + (cellWidth - div.offsetWidth) / 2) + 'px';
        div.style.top = (row * cellHeight + (cellHeight - div.offsetHeight) / 2) + 'px';
    });
});

socket.on("login", function(logindata) {
    $("login").style.display = "none";
    $("chat").style.display = "block";
    $("room_name").innerText = "Room: " + self.room;
    
    Object.keys(logindata.users).forEach(userkey => {
        let user = logindata.users[userkey];
        let x = Math.floor(Math.random() * (window.innerWidth - 200));
        let y = Math.floor(Math.random() * (window.innerHeight - 160 - 32));
        agents[userkey] = new agent(user.name, userkey, x, y, null, user.color, user.voice);
    });
});

socket.on("join", function(user) {
    let x = Math.floor(Math.random() * (window.innerWidth - 200));
    let y = Math.floor(Math.random() * (window.innerHeight - 160 - 32));
    agents[user.guid] = new agent(user.name, user.guid, x, y, null, user.color, user.voice);
});

socket.on("leave", function(guid) {
    agents[guid].kill();
    delete agents[guid];
});

socket.on("update", function(user) {
    let agent = agents[user.guid];
    if (agent) {
        $(agent.id + "n").innerHTML = user.name;
        agent.voice = user.voice;
        if (user.color != agent.color) {
            agent.change(user.color);
        }
    }
});

socket.on("talk", function(text) {
    agents[text.guid].talk(text.text, text.text);
});

socket.on("actqueue", function(queue) {
    agents[queue.guid].actqueue(queue.list, 0);
});

socket.on("update_self", function(info) {
    level = info.level;
    if (info.roomowner) $("room_owner").style.display = "block";
});

socket.on("kick", function(kicker) {
    msWindow("Kicked", `You have been kicked by ${kicker}`);
    sounds.error.play();
});

socket.on("announce", function(data) {
    announcements.push(new msWindow(data.title, data.html));
    if (announcements.length > 3) {
        announcements[0].remove();
        announcements.shift();
    }
});

// Chat log window
let chatLogWindow;
function toggleChatLog() {
    if (chatLogWindow) {
        chatLogWindow.remove();
        chatLogWindow = null;
    } else {
        chatLogWindow = msWindow("Chat Log", '<div id="chat_log"></div>', 10, 10, 300, 400);
    }
}

$("chat_log_button").addEventListener('click', toggleChatLog);

function addToChatLog(message) {
    if (chatLogWindow) {
        let chatLog = chatLogWindow.querySelector('#chat_log');
        let entry = document.createElement('div');
        entry.innerHTML = message;
        chatLog.appendChild(entry);
        chatLog.scrollTop = chatLog.scrollHeight;
    }
}

socket.on("talk", function(text) {
    agents[text.guid].talk(text.text, text.text);
    let htmlText = converter.makeHtml(text.text);
    htmlText = htmlText.replace(/\$r\$(.*?)\$r\$/g, '<span class="rainbow-text">$1</span>');
    htmlText = desanitize(htmlText);
    // Linkify URLs
    htmlText = htmlText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    addToChatLog(`<strong>${agents[text.guid].name}:</strong> ${htmlText}`);
});

// Error handling and disconnection
socket.on('connect_error', (error) => {
    showError('Connection Error', 'Unable to connect to the server. Please check your internet connection and try again.');
    sounds.error.play();
});

socket.on('disconnect', (reason) => {
    if (reason === 'io server disconnect') {
        showError('Disconnected', 'You have been disconnected from the server.');
    } else {
        showError('Connection Lost', 'Lost connection to the server. Attempting to reconnect...');
    }
    sounds.error.play();
});

function showError(title, message) {
    $('error-overlay').style.display = 'flex';
    $('error-message').innerHTML = `<h2>${title}</h2><p>${message}</p>`;
}

// Add a close button to the error message
let closeErrorButton = document.createElement('button');
closeErrorButton.innerText = 'Close';
closeErrorButton.onclick = () => {
    $('error-overlay').style.display = 'none';
};
$('error-message').appendChild(closeErrorButton);

</script>
</body>
</html>
