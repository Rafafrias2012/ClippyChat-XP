<html><head><base href="https://bonziworld.org/"><title>ClippyChat XP Edition</title>
<link rel="stylesheet" href="https://botoxparty.github.io/XP.css/XP.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
@font-face {
    font-family: "Tahoma";
    src: url("./Tahoma.woff");
}

@font-face {
    font-family: "XP_Tahoma";
    src: url("./windows-xp-tahoma.woff");
}

@keyframes rainbow {
    0% { color: red; }
    16% { color: orange; }
    32% { color: yellow; }
    48% { color: lime; }
    64% { color: cyan; }
    80% { color: blue; }
    90% { color: #FF00FF; }
    100% { color: red; }
}

* {
    font-family: "Tahoma";
}

img {
    -webkit-user-drag: none;
}

body {
    margin: 0;
    overscroll-behavior: none;
}

#bg,
#bg img {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -30;
}

#top_bar,
#bottom_bar,
#blur,
#divider,
#login_card,
#readme_block,
#login img,
#loading {
    position: absolute;
}

img {
    user-select: none;
}

#login {
    position: fixed;
    width: 100%;
    height: 100%;
    background-color: #8b5adc;
}

#top_bar,
#bottom_bar {
    width: 100%;
    background-color: #37009C;
}

#top_bar {
    height: 100px;
}

#top_bar div {
    position: absolute;
    width: 100%;
    height: 3px;
    bottom: 0px;
    background: linear-gradient(to right, #340399, rgba(255, 255, 255, 0.85) 25%, rgba(0, 0, 0, 0));
}

#ad_bar {
    position: fixed;
    top: 0;
    z-index: 2;
    width: 100%;
}

#ad_bar center img {
    position: relative;
    margin-top: 18px;
}

#bottom_bar {
    bottom: 0px;
    height: 122px;
    background: linear-gradient(to right, #8934AE, #37009C);
}

#bottom_bar div {
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, #340399, #D9F638 25%, rgba(0, 0, 0, 0));
}

#blur {
    top: 100px;
    width: 250px;
    height: 250px;
    background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.7), rgba(0, 0, 0, 0) 70%);
}

#divider {
    left: 50%;
    transform: translateX(-50%);
    top: 100px;
    height: calc(100% - 222px);
    width: 1px;
    background: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(255, 255, 255, 0.8) 20% 80%, rgba(0, 0, 0, 0));
}

#logo_login,
#logo_mobile {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#logo_mobile {
    display: none;
}

#login_card {
    display: none;
    top: 50%;
    left: 50%;
    transform: translate(20px, -50%);
}

#card_border {
    position: relative;
    width: 300px;
    padding: 1px;
    background: linear-gradient(to right, rgba(255, 255, 255, 0.5) 0% 70%, rgba(0, 0, 0, 0));
    border-radius: 7px;
}

#card_login {
    width: 100%;
    padding: 7px 15px;
    margin: 0;
    background: linear-gradient(to right, #4A00A9 0% 30%, #8b5adc);
    border-radius: 6px;
}

#card_login input {
    width: 160px;
    box-sizing: border-box;
    border: none;
    outline: none;
    border-radius: 3px;
    padding: 4px 3px;
    box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.4);
}

#nickname {
    height: 28px;
    font-size: 14px;
}

#room,
#color {
    height: 18px;
    font-size: 12px;
    margin-top: 8px;
}

#login_button {
    position: absolute;
    top: 50%;
    left: 185px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    background-image: url("./img/login_button.png");
    background-size: 100%;
}

#login_button:hover {
    background-position: 0px -20px;
}

#login_button:active {
    background-position: 0px -40px;
}

#login_error {
    position: absolute;
    display: none;
    background-color: white;
    border-radius: 3px;
    color: red;
    padding: 8px;
    font-size: 12px;
    margin-top: 8px;
    box-shadow: 1px 1px 2px 1px rgba(0, 0, 0, 0.4);
}

#loading {
    top: 50%;
    left: 50%;
    transform: translateX(20px);
    font-weight: bold;
    font-style: italic;
    font-size: 35px;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
    color: white;
}

#readme_block {
    left: 50%;
    bottom: 15%;
    transform: translateX(-50%);
    background-color: white;
    padding: 9px 12px;
    border-radius: 3px;
    color: #444444;
    text-align: center;
}

#version {
    position: absolute;
    color: white;
    font-size: 16px;
    right: 16px;
    bottom: 16px;
}

#content {
    display: none;
    position: fixed;
    width: 100%;
    height: 100%;
    background-color: #452066;
    background-image: url(./img/desktop_logo.png), url(./img/desktop_bg.png);
    background-position: top left, center;
    background-repeat: no-repeat;
}

#chatbar_cont {
    user-select: none;
    position: absolute;
    width: 100%;
    height: 32px;
    bottom: 0;
    z-index: 2;
    background-color: #442D7E;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, #7050C0, rgba(0, 0, 0, 0) 20% 100%), linear-gradient(to bottom, rgba(0, 0, 0, 0.1), rgba(255, 255, 255, 0.05));
}

#talkcard {
    font-size: 14px;
    padding: 3px 10px;
    bottom: 32px;
    left: 0;
    width: calc(100% - 150px);
    position: fixed;
    background-color: #ffffef;
    border: 1px solid black;
    border-bottom: none;
    border-radius: 3px 3px 0px 0px;
}

#talkcard i {
    position: absolute;
    float: right;
    top: 50%;
    right: 0;
    transform: translate(-100%, -50%);
    color: grey;
}

#send_button {
    display: inline-block;
    width: 100px;
    height: 32px;
    background-image: url(./img/start.png);
}

#send_button:hover {
    background-position: 0px -33px;
}

#send_button:active {
    background-position: 0px -66px;
}

#send_button span {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    margin-left: 35px;
    font-size: 16px;
    font-style: italic;
    font-weight: bold;
    color: white;
    letter-spacing: 2px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.75);
}

#chatbar {
    position: absolute;
    top: 3px;
    font-size: 15px;
    width: calc(100% - 132px);
}

#tile {
    position: absolute;
    right: 0px;
    top: 0px;
    width: 27px;
    height: 30px;
    background-image: url(./img/tile.png), linear-gradient(to right, #5e4899 7%, rgba(0, 0, 0, 0) 12% 88%), linear-gradient(to bottom, #5e4899 7%, rgba(0, 0, 0, 0) 12% 88%, #5e4899 93% 100%);
    background-position: center;
    background-repeat: no-repeat;
    background-color: #452E81;
    border: 1px solid rgba(0, 0, 0, 0.7);
}

.agent_cont {
    position: fixed;
    user-drag: none;
    user-select: none;
    z-index: 1;
}

.agent_cont div {
    position: absolute;
    bottom: 0;
}

.nametag {
    position: absolute;
    top: 0;
    border: 1px solid black;
    padding: 7px;
    background: #ffffe1;
    font-size: 12px;
    border-radius: 9px;
    z-index: 2;
    user-select: none;
    max-width: 200%;
    word-wrap: break-word;
}

.tag {
    position: absolute;
    border-style: solid;
    border-width: 4px 12px 4px 0;
    border-radius: 9px;
    border: #000000 solid 1px;
    padding: 5px 6px;
    background: #ffffe1;
    transform: translateY(-100%);
    font-size: 11px;
    font-weight: bold;
    color: black;
    display: none;
}

.bubble-text {
    display: none;
}

.bubble-right::after,
.bubble-left::after {
    position: absolute;
    content: "";
    width: 22px;
    height: 14px;
    top: 12px;
}

.bubble-right::after {
    left: -22px;
    background-image: url(./img/bubble_tail_r.png);
}

.bubble-top::after,
.bubble-bottom::after {
    position: absolute;
    content: "";
    width: 28px;
    height: 22px;
}

.bubble-top::after {
    background-image: url(./img/bubble_tail_t.png);
    left: 110px;
}

.bubble-bottom::after {
    background-image: url(./img/bubble_tail_b.png);
    top: -22px;
    left: 26px;
}

.bubble-left::after {
    right: -22px;
    background-image: url(./img/bubble_tail_l.png);
}

.bubble-left,
.bubble-right,
.bubble-top,
.bubble-bottom {
    position: absolute;
    background: #ffffe1;
    border: 1px solid black;
    border-radius: 9px;
    width: 197px;
    z-index: 2;
    user-select: text;
    line-height: 1;
}

.bubble-left {
    right: 90%;
    top: 40px;
}

.bubble-right {
    left: 90%;
    top: 40px;
}

.bubble-top {
    bottom: 105%;
}

.bubble-bottom {
    top: 100%;
}

span .bubble_text {
    position: relative;
    padding: 12px;
    font-size: 14px;
    word-wrap: break-word;
    overflow-x: hidden;
    overflow-y: auto;
    max-height: 175px;
    margin: 0px;
}

.quote {
    border-left: 3px solid rgba(0, 0, 0, 0.3);
    padding: 2px 3px;
}

.usermedia {
    width: 172px;
    max-height: 172px;
    min-height: 50px;
}

#room_info {
    color: rgba(255, 255, 255, 0.5);
    font-weight: bold;
    line-height: 1.25;
    text-align: right;
    padding: 7px;
    font-size: 12px;
    position: absolute;
    bottom: 30px;
    right: 0;
}

#error_page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
}

.error_message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 32px;
    background-color: #ffffe1;
    color: black;
    border: 1px solid black;
    border-radius: 9px;
    font-size: 17px;
    line-height: 1;
    box-sizing: border-box;
    width: 100%;
    max-width: 600px;
    max-height: 100%;
}

.contextmenu_cont {
    margin: 0;
    position: fixed;
    list-style-type: none;
    z-index: 3;
    background-color: white;
    color: black;
    padding: 2px;
    border: 1px solid grey;
    box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.4);
    user-select: none;
    white-space: nowrap;
    transition: 0.5s;
}

.cmenu_item,
.cmenu_disabled {
    padding: 4px 22px;
    position: relative;
    font-size: 12px;
}

.cmenu_disabled {
    color: grey;
}

.cmenu_item:hover {
    background-color: blue;
    color: white;
    cursor: pointer;
}

.cmenu_list:after {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    content: '';
    border-style: solid;
    width: 0;
    height: 0;
    z-index: 4;
    border-width: 3px 0 3px 3px;
    border-color: transparent transparent transparent black;
    right: 6px;
}

@media screen and (max-width: 560px) {
    #top_bar,
    #bottom_bar,
    #divider {
        display: none;
    }
    #blur {
        top: 0px;
    }
    #login_card,
    #loading {
        transform: translate(-50%, calc(-50%+ 75px));
        z-index: 5;
    }
    #card_border {
        width: 223px;
        background: rgba(255, 255, 255, 0.5);
    }
    #card_login {
        box-sizing: border-box;
        display: inline-block;
        margin-block-end: 0;
    }
    #logo_login {
        display: none;
    }
    #logo_mobile {
        display: block;
    }
    #readme_block {
        bottom: 10%;
    }
}

#log_cont,
.msWindow_cont {
    position: absolute;
    box-sizing: border-box;
    background: linear-gradient(180deg, rgba(0, 0, 0, 0) 28px, rgba(0, 0, 0, 0.25) 31px, rgba(0, 0, 0, 0) 31px), linear-gradient(180deg, rgba(255, 255, 255, 0.2), rgba(0, 0, 0, 0) 5px), linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(255, 255, 255, 0.1) 31px), linear-gradient(180deg, rgba(0, 0, 0, 0) 0px, rgba(255, 255, 255, 0.05) 31px, rgba(0, 0, 0, 0) 31.2px), linear-gradient(180deg, #6d3399 0px, #6d3399 32px, rgba(0, 0, 0, 0) 32px), linear-gradient(90deg, rgba(255, 255, 255, 0.2) 0px, rgba(0, 0, 0, 0) 4px), linear-gradient(0deg, rgba(255, 255, 255, 0.2) 0px, rgba(0, 0, 0, 0) 4px), linear-gradient(270deg, rgba(255, 255, 255, 0.2) 0px, rgba(0, 0, 0, 0) 4px), #6d3399;
    border: 1px solid #582a7a;
    padding: 0px 5px 5px 5px;
    border-top-right-radius: 6px;
    z-index: 1;
}

#log_cont {
    top: 0;
    left: 0;
    width: 350px;
    max-width: calc(100% - 200px);
    height: calc(100% - 32px);
}

.msWindow_cont {
    z-index: 20;
    border-top-left-radius: 6px;
}

.msWindow_cont p {
    user-select: none;
    max-width: 100%;
    max-height: 100%;
}

#log_title,
.msWindow_title {
    margin: 6px 0px 6px 4px;
    color: white;
    font-size: 16px;
    text-shadow: 1.5px 1.5px rgba(0, 0, 0, 0.3);
    white-space: nowrap;
}

#log_body,
.msWindow_body {
    background-color: #F5F5F5;
    box-sizing: border-box;
    padding: 0px 5px 10px 5px;
    width: 100%;
    height: calc(100% - 29px);
    margin: 0;
    overflow-y: scroll;
    word-break: break-word;
}

.msWindow_body {
    padding: 10px 15px;
}

.side img {
    width: 40px;
    height: 40px;
}

.buttonbar {
    margin-top: 7px;
}

.msBtn {
    clear: left;
    font-size: 13px;
    padding: 2px 15px;
    background-color: #F5F5F5;
    border: 2px outset #F5F5F5;
    outline: 1px solid rgba(0, 0, 0, 0.7);
    border-radius: 0px;
}

.msBtn:active {
    border-style: inset;
}

#log_body::-webkit-scrollbar,
.msWindow_body::-webkit-scrollbar {
    display: none;
}

#log_body p {
    margin: 0;
    padding: 7px 0px 0px 0px;
}

.log_close {
    position: relative;
    border: none;
    background-image: url("./img/assets/xpbutton.webp");
    background-size: 100%;
    width: 22px;
    height: 22px;
    font-size: 19px;
    top: -2px;
    padding: 0;
    color: white;
    border-radius: 3px;
    float: right;
    margin-left: 5px;
}

.log_close:hover {
    background-position: 100%;
}

.log_close i {
    margin: 0;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#logshow {
    color: white;
    font-size: 14px;
    display: inline-block;
    margin: 3px 5px;
}

#logshow img {
    width: 45px;
    height: 45px;
}

#pollyes,
#pollno {
    width: 100%;
    height: 40px;
    margin-bottom: 15px;
    border: 1px solid rgba(0, 0, 0, 0.2);
    overflow: hidden;
    position: relative;
}

#innerbar_yes,
#innerbar_no {
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    transition: 0.5s;
}

#pollyes {
    background-color: rgba(0, 255, 0, 0.1);
}

#pollno {
    background-color: rgba(255, 0, 0, 0.1);
}

#innerbar_yes {
    background-color: green;
}

#innerbar_no {
    background-color: red;
}

.polltx {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 20px;
    color: rgba(0, 0, 0, 0.7);
}
</style>
</head>
<body>
<div id="welcome-window" class="window">
    <div class="title-bar">
        <div class="title-bar-text">Welcome to ClippyChat XP</div>
    </div>
    <div class="window-body">
        <h1>Welcome to ClippyChat XP</h1>
        <p>Experience the nostalgia of Windows XP in a modern chat environment!</p>
        <button id="start-chat" class="xp-button">Start Chatting</button>
    </div>
</div>

<div id="login" class="window" style="width: 300px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
    <div class="title-bar">
        <div class="title-bar-text">ClippyChat XP Login</div>
    </div>
    <div class="window-body">
        <p>
            <label for="login_nickname">Nickname:</label>
            <input id="login_nickname" type="text">
        </p>
        <p>
            <label for="login_room">Room ID:</label>
            <input id="login_room" type="text">
        </p>
        <button id="login_button" class="xp-button">Join Chat</button>
        <button id="available-rooms" class="xp-button">Available Rooms</button>
    </div>
</div>

<div id="chat" style="display:none;">
    <div id="agents"></div>
    <div id="chatbar">
        <button id="chat_log_button" title="Toggle Chat Log"></button>
        <button id="tile_agents" class="xp-button">Tile</button>
        <input id="send_message" type="text" placeholder="Type your message...">
        <button id="send_button" class="xp-button">Send</button>
    </div>
    <div id="room_info">
        <span id="room_name"></span>
        <span id="room_owner">Room Owner</span>
    </div>
    <div id="taskbar">
        <img src="https://i.imgur.com/ZSDhCwu.png" alt="Clock" class="taskbar-icon" id="clock-icon">
        <img src="https://i.imgur.com/ZSDhCwu.png" alt="Calculator" class="taskbar-icon" id="calculator-icon">
    </div>

    <div id="talkcard"></div>

<div id="user-counter">Users: <span id="user-count">0</span></div>

<div id="version">V8.0.0</div>

<div id="error-overlay">
    <div id="error-message"></div>
</div>

<script>
const socket = io('https://bonziworld.org/');
let self = {};
let agents = {};
let announcements = [];
let level = 0;
let contextMenu = $('context-menu');
let talkcard = $('talkcard');
let talktarget = null;
window.talkstate = 0;
let welcomeversion = 2;
let settings = loadSettings();
const converter = new showdown.Converter();

// Windows XP Sounds
const sounds = {
    login: new Audio('https://www.myinstants.com/media/sounds/windows-xp-startup.mp3'),
    send: new Audio('https://www.myinstants.com/media/sounds/windows-xp-ding.mp3'),
    error: new Audio('https://www.myinstants.com/media/sounds/windows-xp-error.mp3')
};

function $(id) { return document.getElementById(id); }

function desanitize(text){
    return text.replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, "\"").replace(/&apos;/g, "'").replace(/&lbrack;/g, "square bracket");
}

function range(start, end) {
    return Array.from({length: end - start + 1}, (_, i) => start + i);
}

function msWindow(title, html, x = 100, y = 100, w = 300, h = 200, callback) {
    let win = document.createElement('div');
    win.className = 'window';
    win.style.position = 'absolute';
    win.style.left = x + 'px';
    win.style.top = y + 'px';
    win.style.width = w + 'px';
    win.style.height = h + 'px';
    
    win.innerHTML = `
        <div class="title-bar">
            <div class="title-bar-text">${title}</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close" onclick="this.parentElement.parentElement.parentElement.remove()"></button>
            </div>
        </div>
        <div class="window-body" style="height: calc(100% - 30px); overflow: auto;">
            ${html}
        </div>
    `;
    
    document.body.appendChild(win);
    
    // Make window draggable
    let isDragging = false;
    let dragOffsetX, dragOffsetY;
    
    win.querySelector('.title-bar').addEventListener('mousedown', startDrag);
    win.querySelector('.title-bar').addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        isDragging = true;
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        dragOffsetX = clientX - win.offsetLeft;
        dragOffsetY = clientY - win.offsetTop;
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        win.style.left = (clientX - dragOffsetX) + 'px';
        win.style.top = (clientY - dragOffsetY) + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
    }
    
    // Maximize functionality
    win.querySelector('button[aria-label="Maximize"]').addEventListener('click', () => {
        if (win.style.width === '100%' && win.style.height === '100%') {
            win.style.width = w + 'px';
            win.style.height = h + 'px';
            win.style.left = x + 'px';
            win.style.top = y + 'px';
        } else {
            win.style.width = '100%';
            win.style.height = '100%';
            win.style.left = '0';
            win.style.top = '0';
        }
    });
    
    if (callback) callback(win);
    
    return win;
}

function agent(name, guid, x, y, sheet, color, voice) {
    this.name = name;
    this.guid = guid;
    this.x = x;
    this.y = y;
    this.sheet = sheet;
    this.color = color;
    this.voice = voice;
    this.id = 'agent_' + guid;
    
    let div = document.createElement('div');
    div.id = this.id;
    div.className = 'agent';
    div.style.left = x + 'px';
    div.style.top = y + 'px';
    
    let canvas = document.createElement('canvas');
    let agentType = Math.floor(Math.random() * 6);

    if (agentType === 0) {
        canvas.width = 124;
        canvas.height = 93;
    } else if (agentType === 1) {
        canvas.width = 160;
        canvas.height = 128;
    } else if (agentType === 2) {
        canvas.width = 200;
        canvas.height = 160;
    } else if (agentType === 3 || agentType === 4) {
        canvas.width = 128;
        canvas.height = 128;
    } else {
        canvas.width = 180;
        canvas.height = 180;
    }
    
    div.appendChild(canvas);
    
    let username = document.createElement('div');
    username.id = this.id + 'n';
    username.className = 'username-bubble';
    username.innerText = name;
    div.appendChild(username);
    
    $('agents').appendChild(div);
    
    // Create sprite sheet based on agent type
    let spriteSheet;
    if (agentType === 0) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/clippy.png"],
            frames: {width: 124, height: 93},
            animations: {
                idle: 0,
                enter: {
                    frames: [410, 411, 412, 413, 414, 415, 416],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: [0].concat([...Array(48).keys()].map(i => i + 364)),
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 1) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/peedy.png"],
            frames: {width: 160, height: 128},
            animations: {
                idle: 0,
                enter: {
                    frames: [659, 660, 661, 662, 663, 664, 665, 666, 667, 668, 669, 670, 671, 672, 673, 674, 675, 676, 677, 678, 679, 680, 681],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: [23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47],
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 2) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://bonziworld.org/img/agents/purple.png"],
            frames: {width: 200, height: 160},
            animations: {
                idle: 0,
                enter: {
                    frames: [277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302],
                    next: "idle",
                    speed: 0.25
                },
                leave: {
                    frames: Array.from({ length: 55 }, (_, i) => i + 266),
                    speed: 0.25
                }
            }
        });
    } else if (agentType === 3) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://raw.githubusercontent.com/dwarfpuzzles/Bonzi-oldstolencode/main/build/www/img/bonzi/genie.png"],
            frames: {width: 128, height: 128},
            animations: {
                idle: 0,
                leave: { frames: range(360, 412), next: "gone", speed: 1},
                enter: { frames: range(823, 848), next: "idle", speed: 1}
            }
        });
    } else if (agentType === 4) {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://raw.githubusercontent.com/dwarfpuzzles/Bonzi-oldstolencode/main/build/www/img/bonzi/merlin.png"],
            frames: {width: 128, height: 128},
            animations: {
                idle: 0,
                leave: { frames: range(360, 412), next: "gone", speed: 1},
                enter: { frames: range(823, 848), next: "idle", speed: 1}
            }
        });
    } else {
        spriteSheet = new createjs.SpriteSheet({
            images: ["https://raw.githubusercontent.com/Rafafrias2012/ClippyChat-XP/main/victor.png"],
            frames: {width: 180, height: 180},
            animations: {
                idle: 0,
                enter: {
                    frames: [716, 717, 718, 719, 720, 721, 722, 723, 724, 725, 726, 727, 728, 729, 730, 731, 732, 733, 734, 735, 736, 737, 738, 739, 740, 741, 742, 743, 744, 745, 746, 747],
                    next: "idle",
                    speed: 0.5
                },
                leave: {
                    frames: Array.from({length: 55}, (_, i) => 266 + i),
                    speed: 0.25
                }
            }
        });
    }
    
    // Create sprite
    this.sprite = new createjs.Sprite(spriteSheet, "idle");
    
    // Create stage and add sprite to it
    this.stage = new createjs.Stage(canvas);
    this.stage.addChild(this.sprite);
    
    // Update stage
    createjs.Ticker.addEventListener("tick", this.stage);
    
    this.talk = function(text, say) {
        let bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        
        // Convert markdown to HTML
        let htmlText = converter.makeHtml(text);
        
        // Process rainbow text
        htmlText = htmlText.replace(/\$r\$(.*?)\$r\$/g, '<span class="rainbow-text">$1</span>');
        
        // Desanitize the text
        htmlText = desanitize(htmlText);
        
        // Censor R34 images
        htmlText = htmlText.replace(/<img.*?src=".*?rule34\.xxx.*?".*?>/gi, '[R34 Image Censored]');
        
        // Linkify URLs
        htmlText = htmlText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        
        bubble.innerHTML = htmlText;
        div.appendChild(bubble);
        
        setTimeout(() => bubble.remove(), 5000);
        
        let url = "https://www.tetyys.com/SAPI4/SAPI4?text=" + encodeURIComponent(say) + "&voice=" + encodeURIComponent("Sam") + "&pitch=150&speed=100";
        let audio = new Audio(url);
        audio.play();
    }
    
    this.change = function(newColor) {
        this.color = newColor;
    }
    
    this.kill = function() {
        this.sprite.gotoAndPlay("leave");
        this.sprite.addEventListener("animationend", () => {
            div.remove();
        });
    }
    
    this.actqueue = function(queue, index) {
        if (index >= queue.length) return;
        let act = queue[index];
        // Implement act logic here
        setTimeout(() => this.actqueue(queue, index + 1), act.duration || 1000);
    }
    
    // Make agent draggable
    let isDragging = false;
    let dragOffsetX, dragOffsetY;
    
    div.addEventListener('mousedown', startDrag);
    div.addEventListener('touchstart', startDrag);
    
    function startDrag(e) {
        isDragging = true;
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        dragOffsetX = clientX - div.offsetLeft;
        dragOffsetY = clientY - div.offsetTop;
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        let clientX = e.clientX || e.touches[0].clientX;
        let clientY = e.clientY || e.touches[0].clientY;
        div.style.left = (clientX - dragOffsetX) + 'px';
        div.style.top = (clientY - dragOffsetY) + 'px';
    }
    
    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
    }
    
    // Play enter animation
    this.sprite.gotoAndPlay("enter");
}

function send() {
    let tosend = $("send_message").value;
    if (window.talkstate == 2) {
        talkcard.style.display = "none";
        window.talkstate = 0;
        socket.emit("command", {
            command: "reply",
            param: talktarget + " " + tosend
        });
    } else if (window.talkstate == 1) {
        talkcard.style.display = "none";
        window.talkstate = 0;
        socket.emit("command", {
            command: "dm",
            param: talktarget + " " + tosend
        });
    } else if (tosend.startsWith("/")) {
        let comd = tosend.split(" ")[0].replace("/", '');
        let param = tosend.includes(" ") ? tosend.substring(tosend.indexOf(" ") + 1, tosend.length) : "";
        socket.emit("command", {command: comd, param: param});
    } else {
        socket.emit("talk", $("send_message").value);
    }
    $("send_message").value = "";
    sounds.send.play();
}

$("start-chat").addEventListener("click", function() {
    $("welcome-window").style.display = "none";
    $("login").style.display = "block";
});

$("login_button").addEventListener("click", function() {
    self = {
        name: $("login_nickname").value,
        room: $("login_room").value,
        color: ""
    };
    socket.emit("login", self);
    sounds.login.play();
});

$("send_button").addEventListener("click", send);
$("send_message").addEventListener("keydown", function(e) {
    if (e.keyCode === 13) send();
});

$("tile_agents").addEventListener("click", function() {
    let agentDivs = document.querySelectorAll('.agent');
    let containerWidth = window.innerWidth;
    let containerHeight = window.innerHeight - 50; // Subtracting height of chatbar
    let cols = Math.floor(Math.sqrt(agentDivs.length));
    let rows = Math.ceil(agentDivs.length / cols);
    let cellWidth = containerWidth / cols;
    let cellHeight = containerHeight / rows;

    agentDivs.forEach((div, index) => {
        let row = Math.floor(index / cols);
        let col = index % cols;
        div.style.left = (col * cellWidth + (cellWidth - div.offsetWidth) / 2) + 'px';
        div.style.top = (row * cellHeight + (cellHeight - div.offsetHeight) / 2) + 'px';
    });
});

$("available-rooms").addEventListener("click", function() {
    socket.emit("get_rooms");
});

$("clock-icon").addEventListener("click", function() {
    let clockWindow = msWindow("Clock", `
        <div id="clock" style="font-size: 24px; text-align: center; margin-top: 20px;"></div>
    `, 100, 100, 200, 150);
    
    function updateClock() {
        let now = new Date();
        let clockElement = clockWindow.querySelector("#clock");
        clockElement.textContent = now.toLocaleTimeString();
    }
    
    updateClock();
    setInterval(updateClock, 1000);
});

$("calculator-icon").addEventListener("click", function() {
    let calcWindow = msWindow("Calculator", `
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px;">
            <input type="text" id="calc-display" style="grid-column: span 4; margin-bottom: 10px;">
            <button onclick="document.getElementById('calc-display').value=''">C</button>
            <button onclick="document.getElementById('calc-display').value+='7'">7</button>
            <button onclick="document.getElementById('calc-display').value+='8'">8</button>
            <button onclick="document.getElementById('calc-display').value+='9'">9</button>
            <button onclick="document.getElementById('calc-display').value+='4'">4</button>
            <button onclick="document.getElementById('calc-display').value+='5'">5</button>
            <button onclick="document.getElementById('calc-display').value+='6'">6</button>
            <button onclick="document.getElementById('calc-display').value+='1'">1</button>
            <button onclick="document.getElementById('calc-display').value+='2'">2</button>
            <button onclick="document.getElementById('calc-display').value+='3'">3</button>
            <button onclick="document.getElementById('calc-display').value+='0'">0</button>
            <button onclick="document.getElementById('calc-display').value+='.'">.</button>
            <button onclick="document.getElementById('calc-display').value+='+'">+</button>
            <button onclick="document.getElementById('calc-display').value+='-'">-</button>
            <button onclick="document.getElementById('calc-display').value+='*'">*</button>
            <button onclick="document.getElementById('calc-display').value+='/'">/</button>
            <button onclick="try{document.getElementById('calc-display').value=eval(document.getElementById('calc-display').value)}catch(e){document.getElementById('calc-display').value='Error'}" style="grid-column: span 4;">=</button>
        </div>
    `, 150, 150, 250, 300);
});

socket.on("login", function(logindata) {
    $("login").style.display = "none";
    $("chat").style.display = "block";
    $("room_name").innerText = "Room: " + self.room;
    
    Object.keys(logindata.users).forEach(userkey => {
        let user = logindata.users[userkey];
        let x = Math.floor(Math.random() * (window.innerWidth - 200));
        let y = Math.floor(Math.random() * (window.innerHeight - 160 - 32));
        agents[userkey] = new agent(user.name, userkey, x, y, null, user.color, user.voice);
    });
    
    updateUserCount(Object.keys(logindata.users).length);
});

socket.on("join", function(user) {
    let x = Math.floor(Math.random() * (window.innerWidth - 200));
    let y = Math.floor(Math.random() * (window.innerHeight - 160 - 32));
    agents[user.guid] = new agent(user.name, user.guid, x, y, null, user.color, user.voice);
    updateUserCount(Object.keys(agents).length);
});

socket.on("leave", function(guid) {
    agents[guid].kill();
    delete agents[guid];
    updateUserCount(Object.keys(agents).length);
});

socket.on("update", function(user) {
    let agent = agents[user.guid];
    if (agent) {
        $(agent.id + "n").innerHTML = user.name;
        agent.voice = user.voice;
        if (user.color != agent.color) {
            agent.change(user.color);
        }
    }
});

socket.on("talk", function(text) {
    agents[text.guid].talk(text.text, text.text);
});

socket.on("actqueue", function(queue) {
    agents[queue.guid].actqueue(queue.list, 0);
});

socket.on("update_self", function(info) {
    level = info.level;
    if (info.roomowner) $("room_owner").style.display = "block";
});

socket.on("kick", function(kicker) {
    msWindow("Kicked", `<img id="kick-logo" src="https://i.imgur.com/jacoj5E.png" alt="Kick Logo"><p>You have been kicked by ${kicker}</p>`);
    sounds.error.play();
});

socket.on("announce", function(data) {
    announcements.push(new msWindow(data.title, data.html));
    if (announcements.length > 3) {
        announcements[0].remove();
        announcements.shift();
    }
});

socket.on("room_list", function(rooms) {
    let roomList = rooms.map(room => `<li>${room.name} (${room.users} users)</li>`).join('');
    msWindow("Available Rooms", `<ul>${roomList}</ul>`);
});

// Chat log window
let chatLogWindow;
function toggleChatLog() {
    if (chatLogWindow) {
        chatLogWindow.remove();
        chatLogWindow = null;
    } else {
        chatLogWindow = msWindow("Chat Log", '<div id="chat_log"></div>', 10, 10, 300, 400);
    }
}

$("chat_log_button").addEventListener('click', toggleChatLog);

function addToChatLog(message) {
    if (chatLogWindow) {
        let chatLog = chatLogWindow.querySelector('#chat_log');
        let entry = document.createElement('div');
        entry.innerHTML = message;
        chatLog.appendChild(entry);
        chatLog.scrollTop = chatLog.scrollHeight;
    }
}

socket.on("talk", function(text) {
    agents[text.guid].talk(text.text, text.text);
    let htmlText = converter.makeHtml(text.text);
    htmlText = htmlText.replace(/\$r\$(.*?)\$r\$/g, '<span class="rainbow-text">$1</span>');
    htmlText = desanitize(htmlText);
    // Linkify URLs
    htmlText = htmlText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    addToChatLog(`<strong>${agents[text.guid].name}:</strong> ${htmlText}`);
});

// Error handling and disconnection
socket.on('connect_error', (error) => {
    showError('Connection Error', '<img id="disconnect-logo" src="https://i.imgur.com/jacoj5E.png" alt="Disconnect Logo"><p>Unable to connect to the server. Please check your internet connection and try again.</p>');
    sounds.error.play();
});

socket.on('disconnect', (reason) => {
    if (reason === 'io server disconnect') {
        showError('Disconnected', '<img id="disconnect-logo" src="https://i.imgur.com/jacoj5E.png" alt="Disconnect Logo"><p>You have been disconnected from the server.</p>');
    } else {
        showError('Connection Lost', '<img id="disconnect-logo" src="https://i.imgur.com/jacoj5E.png" alt="Disconnect Logo"><p>Lost connection to the server. Attempting to reconnect...</p>');
    }
    sounds.error.play();
    if (autojoin) {
        setTimeout(() => {
            socket.connect();
            socket.emit("login", self);
        }, 5000);
    }
});

function showError(title, message) {
    $('error-overlay').style.display = 'flex';
    $('error-message').innerHTML = `<h2>${title}</h2>${message}`;
}

// Add a close button to the error message
let closeErrorButton = document.createElement('button');
closeErrorButton.innerText = 'Close';
closeErrorButton.onclick = () => {
    $('error-overlay').style.display = 'none';
};
$('error-message').appendChild(closeErrorButton);

function updateUserCount(count) {
    $('user-count').innerText = count;
}

// Windows XP Icon Function
function createWindowsXPIcon(name, iconUrl, clickHandler) {
    let icon = document.createElement('div');
    icon.className = 'windows-xp-icon';
    icon.style.width = '64px';
    icon.style.height = '64px';
    icon.style.position = 'absolute';
    icon.style.cursor = 'pointer';
    icon.style.textAlign = 'center';
    
    let img = document.createElement('img');
    img.src = iconUrl;
    img.style.width = '32px';
    img.style.height = '32px';
    
    let text = document.createElement('div');
    text.textContent = name;
    text.style.fontSize = '12px';
    text.style.wordWrap = 'break-word';
    text.style.color = 'white';
    text.style.textShadow = '1px 1px 1px black';
    
    icon.appendChild(img);
    icon.appendChild(text);
    
    icon.addEventListener('click', clickHandler);
    
    document.body.appendChild(icon);
    
    return icon;
}

// Create desktop icons
createWindowsXPIcon('My Computer', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/MyComputer.png', () => {
    msWindow('My Computer', '<p>This is your computer.</p>');
});

createWindowsXPIcon('Recycle Bin', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/RecycleBin(empty).png', () => {
    msWindow('Recycle Bin', '<p>The recycle bin is empty.</p>');
});

createWindowsXPIcon('Internet Explorer', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/InternetExplorer6.png', () => {
    msWindow('Internet Explorer', '<iframe src="https://www.example.com" style="width: 100%; height: 100%; border: none;"></iframe>', 100, 100, 800, 600);
});

// Position icons
let icons = document.querySelectorAll('.windows-xp-icon');
icons.forEach((icon, index) => {
    icon.style.left = '10px';
    icon.style.top = (10 + index * 80) + 'px';
});

createWindowsXPIcon('Control Panel', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/ControlPanel.png', () => {
    msWindow('Control Panel', `
        <h2>Settings</h2>
        <button id="change-background">Change Background</button>
        <button id="change-theme">Change Theme</button>
        <label><input type="checkbox" id="auto-join"> Enable Autojoin</label>
    `, 100, 100, 300, 200, (win) => {
        win.querySelector('#change-background').addEventListener('click', changeBackground);
        win.querySelector('#change-theme').addEventListener('click', changeTheme);
        win.querySelector('#auto-join').addEventListener('change', toggleAutojoin);
    });
});

function changeBackground() {
    let newBackground = prompt("Enter new background URL:");
    if (newBackground) {
        document.body.style.backgroundImage = `url('${newBackground}')`;
    }
}

function changeTheme() {
    let newTheme = prompt("Enter new theme URL:");
    if (newTheme) {
        let link = document.querySelector("link[href^='https://botoxparty.github.io/XP.css/XP.css']");
        if (link) {
            link.href = newTheme;
        }
    }
}

let autojoin = false;
function toggleAutojoin(e) {
    autojoin = e.target.checked;
}

// Poll functionality
let poll;

socket.on("poll", data => {
    if (poll != undefined) {
        poll.remove();
    }
    poll = msWindow("Poll from " + data.name, `
      <h1>${data.title}</h1>
      <div id="pollyes"><div id="innerbar_yes"></div><span class='polltx'>YES</span></div>
      <div id="pollno"><div id="innerbar_no"></div><span class='polltx'>NO</span></div>
      <span id="votecount">0</span> Votes!
      `, undefined, undefined, window.innerWidth / 2);
    $("pollyes").onclick = () => {
        socket.emit('command', {
            command: 'vote',
            param: 'yes'
        })
    }
    $("pollno").onclick = () => {
        socket.emit('command', {
            command: 'vote',
            param: 'no'
        })
    }
});

socket.on("vote", data => {
    if (poll == undefined) return;
    let tvotes = data.yes + data.no;
    $("innerbar_yes").style.width = data.yes / tvotes * 100 + "%";
    $("innerbar_no").style.width = data.no / tvotes * 100 + "%";
    $("votecount").innerHTML = tvotes;
});

function showContextMenu(e, agentId) {
    e.preventDefault();
    contextMenu.style.display = 'block';
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
    talktarget = agentId;
}

$('reply-option').addEventListener('click', () => {
    window.talkstate = 2;
    talkcard.innerHTML = `Replying to ${agents[talktarget].name} <i class='fa fa-times' onclick='this.parentElement.style.display="none";window.talkstate=0;'></i>`;
    talkcard.style.display = "inline-block";
    contextMenu.style.display = 'none';
});

$('dm-option').addEventListener('click', () => {
    window.talkstate = 1;
    talkcard.innerHTML = `Sending a private message to ${agents[talktarget].name} <i class='fa fa-times' onclick='this.parentElement.style.display="none";window.talkstate=0;'></i>`;
    talkcard.style.display = "inline-block";
    contextMenu.style.display = 'none';
});

document.addEventListener('click', () => {
    contextMenu.style.display = 'none';
});

document.addEventListener("contextmenu", mouse => {
    mouse.preventDefault();
    moving = false;
    //Find agent the mouse is over
    let bid = -1;
    Object.keys(agents).forEach((akey) => {
        //Check if within bounds of an agent. Pretty long condition.
        if (
            mouse.clientX > agents[akey].x &&
            mouse.clientX < agents[akey].x + agents[akey].w &&
            mouse.clientY > agents[akey].y &&
            mouse.clientY < agents[akey].y + agents[akey].h + agents[akey].toppad
        ) bid = akey;
    })

    //Contextmenu if found passing agent through
    if (bid > -1) {
        //Define the contextmenu upon click (so it can be dynamic)
        let cmenu = [{
            type: 0,
            name: "Cancel",
            callback: (passthrough) => {
                passthrough.cancel();
            }
        }, {
            type: 0,
            name: "Call an Asshole",
            callback: (passthrough) => {
                socket.emit("command", {
                    command: "asshole",
                    param: passthrough.name
                })
            }
        }, {
            type: 0,
            name: "Notice Bulge",
            callback: (passthrough) => {
                socket.emit("command", {
                    command: "owo",
                    param: passthrough.name
                })
            }
        }, {
            type: 0,
            name: "Kick",
            disabled: level < 1,
            callback: (passthrough) => {
                socket.emit("command", {
                    command: "kick",
                    param: passthrough.id
                })
            }
        }, {
            type: 0,
            name: "BAN",
            disabled: level <= 2,
            callback: (passthrough) => {
                socket.emit("command", {
                    command: "banmenu",
                    param: passthrough.id
                })
            }
        }]
        contextmenu(cmenu, mouse.clientX, mouse.clientY, agents[bid]);
    }
})

function contextmenu(items, x, y, passthrough) {
    let menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';

    items.forEach(item => {
        let menuItem = document.createElement('div');
        menuItem.className = 'context-menu-item';
        menuItem.textContent = item.name;
        if (item.disabled) {
            menuItem.classList.add('disabled');
        } else {
            menuItem.addEventListener('click', () => {
                item.callback(passthrough);
                menu.remove();
            });
        }
        menu.appendChild(menuItem);
    });

    document.body.appendChild(menu);

    document.addEventListener('click', function closeMenu() {
        menu.remove();
        document.removeEventListener('click', closeMenu);
    });
}

socket.on("banwindow", data => {
    new msWindow("Banning " + data.name, `
<table>
<tr>
<td class="side">
<img src="./img/assets/ban.ico">
</td>
<td>
<span class="win_text">
<table style="margin-left: 10px;">
<tr>Banning ${data.name}, IP ${data.ip}</tr>
<tr><td>Reason:</td><td><input id="reason"></td></tr>
</table>
</span>
</td>
</tr>
</table>
`, undefined, undefined, undefined, undefined, [{
    name: "CANCEL"
}, {
    name: "BAN",
    callback: () => {
        socket.emit("command", {
            command: "ban",
            param: data.ip + " " + $("reason").value
        })
    }
}])
})

socket.on("ban", (data) => {
error_id = "error_ban";
$("banned_by").innerHTML = data.bannedby;
$("own_ip").innerHTML = data.ip;
$("ban_reason").innerHTML = data.reason;
})

// Poll inner bars
$("pollyes").innerHTML = '<div id="innerbar_yes"></div><span class="polltx">YES</span>';
$("pollno").innerHTML = '<div id="innerbar_no"></div><span class="polltx">NO</span>';

// Additional HTML for the chat interface
let chatInterface = `
<div id="chat-window" class="window" style="display:none;">
    <div class="title-bar">
        <div class="title-bar-text">Chat</div>
        <div class="title-bar-controls">
            <button aria-label="Minimize"></button>
            <button aria-label="Maximize"></button>
            <button aria-label="Close"></button>
        </div>
    </div>
    <div class="window-body">
        <div id="chat-messages" style="height: 200px; overflow-y: scroll;"></div>
        <div class="field-row">
            <input id="chat-input" type="text" style="width: 80%;">
            <button id="chat-send">Send</button>
        </div>
    </div>
</div>
`;

document.body.insertAdjacentHTML('beforeend', chatInterface);

$("chat-send").addEventListener("click", function() {
    let message = $("chat-input").value;
    if (message.trim() !== "") {
        socket.emit("talk", message);
        $("chat-input").value = "";
    }
});

$("chat-input").addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        $("chat-send").click();
    }
});

socket.on("talk", function(data) {
    let chatMessages = $("chat-messages");
    let messageElement = document.createElement("div");
    messageElement.innerHTML = `<strong>${data.name}:</strong> ${data.text}`;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
});

// Show chat window button
let showChatButton = createWindowsXPIcon('Open Chat', 'https://raw.githubusercontent.com/softwarehistorysociety/XPIcons/main/XP/PMSHELL.png', () => {
    $("chat-window").style.display = "block";
});

// Make chat window draggable
let chatWindow = $("chat-window");
let isDragging = false;
let dragOffsetX, dragOffsetY;

chatWindow.querySelector('.title-bar').addEventListener('mousedown', (e) => {
    isDragging = true;
    dragOffsetX = e.clientX - chatWindow.offsetLeft;
    dragOffsetY = e.clientY - chatWindow.offsetTop;
});

document.addEventListener('mousemove', (e) => {
    if (isDragging) {
        chatWindow.style.left = (e.clientX - dragOffsetX) + 'px';
        chatWindow.style.top = (e.clientY - dragOffsetY) + 'px';
    }
});

document.addEventListener('mouseup', () => {
    isDragging = false;
});

// Close button functionality
chatWindow.querySelector('button[aria-label="Close"]').addEventListener('click', () => {
    chatWindow.style.display = "none";
});

// Maximize button functionality
chatWindow.querySelector('button[aria-label="Maximize"]').addEventListener('click', () => {
    if (chatWindow.style.width === "100%") {
        chatWindow.style.width = "";
        chatWindow.style.height = "";
        chatWindow.style.top = "";
        chatWindow.style.left = "";
    } else {
        chatWindow.style.width = "100%";
        chatWindow.style.height = "100%";
        chatWindow.style.top = "0";
        chatWindow.style.left = "0";
    }
});

// Minimize button functionality
chatWindow.querySelector('button[aria-label="Minimize"]').addEventListener('click', () => {
    chatWindow.style.display = "none";
    // You might want to add a taskbar icon here to represent the minimized window
});

// Function to save settings
function saveSettings() {
    localStorage.setItem('clippychatSettings', JSON.stringify(settings));
}

// Function to load settings
function loadSettings() {
    let savedSettings = localStorage.getItem('clippychatSettings');
    return savedSettings ? JSON.parse(savedSettings) : {
        background: 'default',
        theme: 'default',
        autojoin: false
    };
}

// Apply saved settings on load
window.addEventListener('load', () => {
    if (settings.background !== 'default') {
        document.body.style.backgroundImage = `url('${settings.background}')`;
    }
    if (settings.theme !== 'default') {
        let link = document.querySelector("link[href^='https://botoxparty.github.io/XP.css/XP.css']");
        if (link) {
            link.href = settings.theme;
        }
    }
    autojoin = settings.autojoin;
});

// Update settings when changed
function updateSettings(key, value) {
    settings[key] = value;
    saveSettings();
}

$('change-background').addEventListener('click', () => {
    let newBackground = prompt("Enter new background URL:");
    if (newBackground) {
        document.body.style.backgroundImage = `url('${newBackground}')`;
        updateSettings('background', newBackground);
    }
});

$('change-theme').addEventListener('click', () => {
    let newTheme = prompt("Enter new theme URL:");
    if (newTheme) {
        let link = document.querySelector("link[href^='https://botoxparty.github.io/XP.css/XP.css']");
        if (link) {
            link.href = newTheme;
            updateSettings('theme', newTheme);
        }
    }
});

$('auto-join').addEventListener('change', (e) => {
    autojoin = e.target.checked;
    updateSettings('autojoin', autojoin);
});

</script>
</body>
</html>
